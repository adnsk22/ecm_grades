str_detect(Term,"FoxO")|
str_detect(Term,"Growth hormone")|
str_detect(Term,"HIF-1")|
str_detect(Term,"Hippo")|
str_detect(Term,"IL-17")|
str_detect(Term,"JAK-STAT")|
str_detect(Term,"MAPK")|
str_detect(Term,"Mitophagy")|
str_detect(Term,"NF-kappa")|
str_detect(Term,"NOD-like")|
str_detect(Term,"Notch")|
str_detect(Term,"PI3K")|
str_detect(Term,"Parathyroid")|
str_detect(Term,"Pathways in cancer")|
str_detect(Term,"Platelet activation")|
str_detect(Term,"Proteoglycans in cancer")|
str_detect(Term,"RIG-I-like")|
str_detect(Term,"Rap1")|
str_detect(Term,"Ras signaling")|
str_detect(Term,"Relaxin")|
str_detect(Term,"pluripotency")|
str_detect(Term,"T cell receptor")|
str_detect(Term,"TGF-beta")|
str_detect(Term,"TNF")|
str_detect(Term,"Th1 and Th2 cell")|
str_detect(Term,"Th17 cell")|
str_detect(Term,"Toll-like")|
str_detect(Term,"Transcriptional")|
str_detect(Term,"Wnt signaling")|
str_detect(Term,"Apelin")|
str_detect(Term,"Leukocyte")|
str_detect(Term,"digestion and")|
str_detect(Term,"AMPK")|
str_detect(Term,"Calcium signaling")|
str_detect(Term,"Cell adhesion")|
str_detect(Term,"Central carbon")|
str_detect(Term,"Phospholipase D")|
str_detect(Term,"Regulation of actin")|
str_detect(Term,"Autophagy")|
str_detect(Term,"Gap junction")|
str_detect(Term,"Hedgehog")|
str_detect(Term,"VEGF")|
str_detect(Term,"p53")|
str_detect(Term,"Cytokine-cytokine")|
str_detect(Term,"Tight junction")) -> terms_filtered
colnames(terms_filtered)=c('Term','ECM-G1' ,'ECM-G2' , 'ECM-G3', 'ECM-G4')
df=data.frame(`ECM Grade` = c('ECM-G1', 'ECM-G2', 'ECM-G3', 'ECM-G4')) %>% rename("ECM Grade"="ECM.Grade")
col_anno_code = HeatmapAnnotation(df = df,
col = list("ECM Grade" = c('ECM-G1' = '#B6CEC7','ECM-G2' = '#86A3C3', 'ECM-G3'='#7268A6', 'ECM-G4'='#6B3074')),
annotation_name_gp = gpar(fontsize=15,fontface = "bold"),
annotation_legend_param = list(`ECM Grade` = list(title = "ECM Grade",  title_gp = gpar(fontface="bold", fontsize = 15), labels_gp = gpar(fontsize = 15))))
cluster_wise_bottom_trim %>%
filter(Pathways%in%terms_filtered$Term) %>%
column_to_rownames("Pathways") %>%
select('ECM-G1'= 1 ,'ECM-G2'=2 , 'ECM-G3'=3, 'ECM-G4'=4) -> percentages
(terms_filtered %>% column_to_rownames("Term"))[rownames(percentages),] -> scores
annotate_percentage <- function(scores, percentages) {
annotations <- matrix("", nrow = nrow(scores), ncol = ncol(scores))
for (i in 1:nrow(scores)) {
if (percentages$'ECM-G1'[i] < 25) annotations[i, 1] <- "*"
if (percentages$'ECM-G2'[i] < 25) annotations[i, 2] <- "*"
if (percentages$'ECM-G3'[i] < 25) annotations[i, 3] <- "*"
if (percentages$'ECM-G4'[i] < 25) annotations[i, 4] <- "*"
}
return(annotations)
}
annotations <- annotate_percentage(scores, percentages)
scores %>%
Heatmap(cluster_columns = F,
cluster_rows = T,
show_row_dend = F,
show_column_names = F,
col = colorRamp2(c(-0.5,0,0.5),c("navy","white","maroon4")),
height=1*unit(250,"mm"),
width=1*unit(50,"mm"),
column_names_rot = 0,
column_names_centered = T,
row_names_gp = gpar(fontsize=13),
name = "Enrichment\nScore",
top_annotation = col_anno_code,
column_title = "KEGG Pathways",
column_title_side = "top",
column_title_gp = gpar(fontsize=15, fontface="bold"),
show_row_names = T,
heatmap_legend_param = list(title = "Enrichment\nScore", title_gp = gpar(fontface="bold", fontsize = 15), labels_gp = gpar(fontsize = 15)),
cell_fun = function(j, i, x, y, width, height, fill) {grid.text(annotations[i, j], x, y, gp = gpar(fontsize = 15, col = "black"))}) -> ptx_heat
draw(ptx_heat, merge_legend = T, heatmap_legend_side="left")
patient_enrichments_kegg %>%
filter(str_detect(Term,"ECM")) %>%
select(ends_with("_trx")) %>%
t() %>%
as.data.frame() %>%
filter(!is.na(V1)) %>%
rownames_to_column("patients") %>%
mutate(patients=str_replace(patients, "_trx", "")) %>%
inner_join(momix_cluster_annotation) %>%
select(ecm_type, V1) %>%
ggplot(aes(x=ecm_type, y=V1, fill=ecm_type))+
geom_boxplot()+
geom_dotplot(binaxis='y', stackdir='center', dotsize=0.6)+
stat_compare_means(comparisons = list(c("poorest","poor"), c("poor","rich"), c("rich","richest"), c("poorest","rich"), c("poor","richest"), c("poorest","richest")),
aes(label = ..p.signif..), size=5,
symnum.args = list(cutpoints = c(0, 0.001, 0.01, 0.05, Inf), symbols = c( "***", "**", "*", "ns")))+
theme_minimal()+
theme(axis.text.x = element_text(size=20, angle = 45, hjust=1, color="black"),
axis.text.y = element_text(size=20, color="black"),
axis.title.y = element_text(size=25, face="bold"),
axis.title.x = element_blank(),
line = element_blank(),
legend.position = "none")+
scale_fill_manual(values = c('poorest' = '#B6CEC7','poor' = '#86A3C3', 'rich'='#7268A6', 'richest'='#6B3074')) +
scale_x_discrete(labels = c("poorest" = "ECM-G1", "poor" = "ECM-G2", "rich" = "ECM-G3", "richest" = "ECM-G4"))+
border(color="black") +
ylab("ECM-Receptor Interaction") -> k1
patient_enrichments_kegg %>%
filter(str_detect(Term,"PI3K")) %>%
select(ends_with("_trx")) %>%
t() %>%
as.data.frame() %>%
filter(!is.na(V1)) %>%
rownames_to_column("patients") %>%
mutate(patients=str_replace(patients, "_trx", "")) %>%
inner_join(momix_cluster_annotation) %>%
select(ecm_type, V1) %>%
ggplot(aes(x=ecm_type, y=V1, fill=ecm_type))+
geom_boxplot()+
geom_dotplot(binaxis='y', stackdir='center', dotsize=0.6)+
stat_compare_means(comparisons = list(c("poorest","poor"), c("poor","rich"), c("rich","richest"), c("poorest","rich"), c("poor","richest"), c("poorest","richest")),
aes(label = ..p.signif..), size=5,
symnum.args = list(cutpoints = c(0, 0.001, 0.01, 0.05, Inf), symbols = c( "***", "**", "*", "ns")))+
theme_minimal()+
theme(axis.text.x = element_text(size=20, angle = 45, hjust=1, color="black"),
axis.text.y = element_text(size=20, color="black"),
axis.title.y = element_text(size=25, face="bold"),
axis.title.x = element_blank(),
line = element_blank(),
legend.position = "none")+
scale_fill_manual(values = c('poorest' = '#B6CEC7','poor' = '#86A3C3', 'rich'='#7268A6', 'richest'='#6B3074')) +
scale_x_discrete(labels = c("poorest" = "ECM-G1", "poor" = "ECM-G2", "rich" = "ECM-G3", "richest" = "ECM-G4"))+
border(color="black") +
ylab("PI3K-Akt Signaling Pathway") -> k2
patient_enrichments_kegg %>%
filter(str_detect(Term,"Focal")) %>%
select(ends_with("_trx")) %>%
t() %>%
as.data.frame() %>%
filter(!is.na(V1)) %>%
rownames_to_column("patients") %>%
mutate(patients=str_replace(patients, "_trx", "")) %>%
inner_join(momix_cluster_annotation) %>%
select(ecm_type, V1) %>%
ggplot(aes(x=ecm_type, y=V1, fill=ecm_type))+
geom_boxplot()+
geom_dotplot(binaxis='y', stackdir='center', dotsize=0.6)+
stat_compare_means(comparisons = list(c("poorest","poor"), c("poor","rich"), c("rich","richest"), c("poorest","rich"), c("poor","richest"), c("poorest","richest")),
aes(label = ..p.signif..), size=5,
symnum.args = list(cutpoints = c(0, 0.001, 0.01, 0.05, Inf), symbols = c( "***", "**", "*", "ns")))+
theme_minimal()+
theme(axis.text.x = element_text(size=20, angle = 45, hjust=1, color="black"),
axis.text.y = element_text(size=20, color="black"),
axis.title.y = element_text(size=25, face="bold"),
axis.title.x = element_blank(),
line = element_blank(),
legend.position = "none")+
scale_fill_manual(values = c('poorest' = '#B6CEC7','poor' = '#86A3C3', 'rich'='#7268A6', 'richest'='#6B3074')) +
scale_x_discrete(labels = c("poorest" = "ECM-G1", "poor" = "ECM-G2", "rich" = "ECM-G3", "richest" = "ECM-G4"))+
border(color="black") +
ylab("Focal Adhesion") -> k3
k1+k2+k3
patient_enrichments_hall %>%
column_to_rownames("Term") %>%
select(ends_with("_trx")) %>%
rename_with(~str_replace(.,"_trx","")) %>%
#filter(rowSums(.)<75) %>%
#filter(rowSums(.)>25) %>%
t() %>%
as.data.frame() %>%
mutate_all(~ifelse(is.na(.),0,1)) %>%
rownames_to_column("patients") %>%
inner_join(momix_cluster_annotation) %>%
select(-patients,-consensuscluster, -`ECM Grade`) %>%
select(ecm_type, everything(.)) %>%
group_by(ecm_type) %>%
summarize_all(sum) %>%
column_to_rownames("ecm_type") %>%
t() %>%
as.data.frame() %>%
rownames_to_column("Pathways") %>%
mutate(poorest=(poorest/21)*100) %>%
mutate(poor=(poor/35)*100) %>%
mutate(rich=(rich/32)*100) %>%
mutate(richest=(richest/13)*100) %>%
filter(poorest>=25 | poor>=25 | rich>=25 | richest>=25 ) -> cluster_wise_bottom_trim_hall
# heatmap
patient_enrichments_hall %>%
select(Term, ends_with("_trx")) %>%
rename_with(~str_replace(.,"_trx","")) %>%
filter(Term%in%cluster_wise_bottom_trim_hall$Pathways) %>%
column_to_rownames("Term") %>%
t() %>%
as.data.frame() %>%
rownames_to_column("patients") %>%
inner_join(momix_cluster_annotation) %>%
select(-patients, -consensuscluster) %>%
group_by(ecm_type) %>%
summarize_all(mean, na.rm=T) %>%
column_to_rownames("ecm_type") %>%
t() %>%
as.data.frame() %>%
select(poorest, poor, rich,richest) %>%
rownames_to_column("Term") %>%
filter(str_detect(Term, "Allograft Rejection")|
str_detect(Term, "Angiogenesis")|
str_detect(Term, "Apical Junction")|
str_detect(Term, "Apoptosis")|
str_detect(Term, "Coagulation")|
str_detect(Term, "Complement")|
str_detect(Term, "Epithelial Mesenchymal")|
str_detect(Term, "Hedgehog")|
str_detect(Term, "Hypoxia")|
str_detect(Term, "IL-6")|
str_detect(Term, "Inflammatory")|
str_detect(Term, "KRAS")|
str_detect(Term, "PI3K")|
str_detect(Term, "TGF")|
str_detect(Term, "TNF")|
str_detect(Term, "Wnt")|
str_detect(Term, "p53")|
str_detect(Term, "DNA Repair")|
str_detect(Term, "Glycolysis")) %>%
column_to_rownames("Term") -> picked_halls
colnames(picked_halls)=c('ECM-G1' ,'ECM-G2' , 'ECM-G3', 'ECM-G4')
df=data.frame(`ECM Grade` = c('ECM-G1', 'ECM-G2', 'ECM-G3', 'ECM-G4')) %>% rename("ECM Grade"="ECM.Grade")
col_anno_code = HeatmapAnnotation(df = df,
col = list("ECM Grade" = c('ECM-G1' = '#B6CEC7','ECM-G2' = '#86A3C3', 'ECM-G3'='#7268A6', 'ECM-G4'='#6B3074')),
annotation_name_gp = gpar(fontsize=15,fontface = "bold"),
annotation_legend_param = list(`ECM Grade` = list(  title = "ECM Grade",  title_gp = gpar(fontface="bold", fontsize = 15), labels_gp = gpar(fontsize = 15))),
show_legend = T)
cluster_wise_bottom_trim_hall %>%
filter(Pathways%in%rownames(picked_halls)) %>%
column_to_rownames("Pathways") %>%
select('ECM-G1'= 1 ,'ECM-G2'=2 , 'ECM-G3'=3, 'ECM-G4'=4) -> percentages
picked_halls[rownames(percentages),] -> scores
annotate_percentage <- function(scores, percentages) {
annotations <- matrix("", nrow = nrow(scores), ncol = ncol(scores))
for (i in 1:nrow(scores)) {
if (percentages$'ECM-G1'[i] < 25) annotations[i, 1] <- "*"
if (percentages$'ECM-G2'[i] < 25) annotations[i, 2] <- "*"
if (percentages$'ECM-G3'[i] < 25) annotations[i, 3] <- "*"
if (percentages$'ECM-G4'[i] < 25) annotations[i, 4] <- "*"
}
return(annotations)
}
annotations <- annotate_percentage(scores, percentages)
scores %>%
Heatmap(cluster_columns = F,
cluster_rows = T,
show_row_dend = F,
show_column_names = F,
col = colorRamp2(c(-0.5,0,0.5),c("navy","white","maroon4")),
height=1*unit(100,"mm"),
width=1*unit(30,"mm"),
column_names_rot = 0,
column_names_centered = T,
row_names_gp = gpar(fontsize=15),
name = "Enrichment\nScore",
top_annotation = col_anno_code,
column_title = "Hallmarks",
column_title_side = "top",
column_title_gp = gpar(fontsize=20, fontface="bold"),
show_row_names = T,
show_heatmap_legend = T,
heatmap_legend_param = list(title = "Enrichment\nScore", title_gp = gpar(fontface="bold", fontsize = 15), labels_gp = gpar(fontsize = 15)),
cell_fun = function(j, i, x, y, width, height, fill) {grid.text(annotations[i, j], x, y, gp = gpar(fontsize = 15, col = "black"))}) -> ptx_heat
draw(ptx_heat, merge_legend = T, heatmap_legend_side="left")
all_tfs=data.frame(name=as.character())
for (i in momix_cluster_annotation$patients) {
read_tsv(paste0("out_data/terminals/",i,".tsv")) %>%
filter(Category=="TF") %>%
select(1) %>%
mutate(x=1)%>%
rename_with(~i, .cols = x) -> ptfs
all_tfs=full_join(all_tfs, ptfs, by="name")
}
read_tsv(paste0("out_data/terminals/",i,".tsv"))
i
#all_tfs %>% write_csv("out_data/lists/all_tfs.csv")
all_tfs=read_csv("out_data/lists/all_tfs.csv")
trx_zscores_raw %>%
filter(Hugo_Symbol%in%all_tfs$TFs) -> all_tfs_wdata
all_tfs %>%
filter(!TFs%in%c("ZNF300","CREM","NCOA3","GLI2", "NKX2-1")) %>%
column_to_rownames("TFs") %>%
select(momix_cluster_annotation$patients) %>%
#filter(rowSums(.)<75) %>%
#filter(rowSums(.)>25) %>%
t() %>%
as.data.frame() %>%
rownames_to_column("patients") %>%
inner_join(momix_cluster_annotation) %>%
select(-patients, -consensuscluster, -`ECM Grade`) %>%
select("ecm_type", everything(.)) %>%
group_by(ecm_type) %>%
summarise_all(sum) %>%
column_to_rownames("ecm_type") %>%
t() %>%
as.data.frame() %>%
rownames_to_column("TFs") %>%
mutate(poorest=(poorest/21)*100) %>%
mutate(poor=(poor/35)*100) %>%
mutate(rich=(rich/32)*100) %>%
mutate(richest=(richest/13)*100) %>%
filter(poorest>=25 | poor>=25 | rich>=25 | richest>=25 ) %>%
select(TFs, poorest, poor, rich, richest)-> tfsubset
trx_zscores_raw %>%
filter(Hugo_Symbol%in%tfsubset$TFs) %>%
select(Hugo_Symbol,momix_cluster_annotation$patients) %>%
column_to_rownames("Hugo_Symbol") %>%
t() %>%
as.data.frame() %>%
rownames_to_column("patients") %>%
inner_join(momix_cluster_annotation) %>%
select(-patients, -consensuscluster, -`ECM Grade`) %>%
select(ecm_type,everything()) %>%
group_by(ecm_type) %>%
summarise_all(median, na.rm=T) %>%
column_to_rownames("ecm_type") %>%
t() %>%
as.data.frame() %>%
rownames_to_column("TFs") %>%
mutate(keep=ifelse((richest>=rich & rich>=poor & poor>=poorest) | (richest<=rich & rich<=poor & poor<=poorest),"yes","no")) %>%  # Trend filtering
#mutate(keep=ifelse((richest>=rich & poor>=poorest & richest>=poorest) | (richest<=rich & poor<=poorest & richest<=poorest),"yes","no")) %>%  # Soft trend filtering
filter(keep=="yes") %>%
select(-keep) %>%
column_to_rownames("TFs")%>%
select(poorest, poor, rich, richest) -> final_tfs
colnames(final_tfs)=c('ECM-G1' ,'ECM-G2' , 'ECM-G3', 'ECM-G4')
df=data.frame(`ECM Grade` = c('ECM-G1', 'ECM-G2', 'ECM-G3', 'ECM-G4')) %>% rename("ECM Grade"="ECM.Grade")
heatanno=HeatmapAnnotation(df = df,
col = list("ECM Grade" = c('ECM-G1' = '#B6CEC7','ECM-G2' = '#86A3C3', 'ECM-G3'='#7268A6', 'ECM-G4'='#6B3074')),
annotation_name_gp = gpar(fontsize=15,fontface = "bold"),
annotation_legend_param = list(`ECM Grade` = list(title = "ECM Grade",  title_gp = gpar(fontface="bold", fontsize = 15), labels_gp = gpar(fontsize = 15))))
tfsubset %>%
filter(TFs%in%rownames(final_tfs)) %>%
column_to_rownames("TFs") %>%
select('ECM-G1'= 1 ,'ECM-G2'=2 , 'ECM-G3'=3, 'ECM-G4'=4) -> percentages
final_tfs[rownames(percentages),] -> scores
annotate_percentage <- function(scores, percentages) {
annotations <- matrix("", nrow = nrow(scores), ncol = ncol(scores))
for (i in 1:nrow(scores)) {
if (percentages$'ECM-G1'[i] < 25) annotations[i, 1] <- "*"
if (percentages$'ECM-G2'[i] < 25) annotations[i, 2] <- "*"
if (percentages$'ECM-G3'[i] < 25) annotations[i, 3] <- "*"
if (percentages$'ECM-G4'[i] < 25) annotations[i, 4] <- "*"
}
return(annotations)
}
annotations <- annotate_percentage(scores, percentages)
scores %>%
Heatmap(cluster_columns = F,
show_column_names = F,
cluster_rows = T,
show_row_dend = F,
width = unit(30,"mm"),
column_names_centered = T,
column_title = "TFs",
column_title_gp = gpar(fontsize=20, fontface="bold"),
height = unit(100,"mm"),
name = "Enrichment\nScore",
row_names_gp = gpar(fontsize=15),
col = colorRamp2(c(-0.5,0,0.5), c("navy", "white", "maroon4")),
top_annotation = heatanno,
heatmap_legend_param = list(title = "Enrichment\nScore", title_gp = gpar(fontface="bold", fontsize = 15), labels_gp = gpar(fontsize = 15)),
cell_fun = function(j, i, x, y, width, height, fill) {grid.text(annotations[i, j], x, y, gp = gpar(fontsize = 20, col = "black"))}) -> tf_heat
draw(tf_heat, merge_legend = T)
# Fix drugbank data for network proximity analysis
drug_targets=read_csv("data/DRUGBANK_14_03_2024/uniprot links.csv")
drug_target_ids=read_csv("data/DRUGBANK_14_03_2024/all.csv") %>%
filter(Species=="Humans") %>%
select(`UniProt ID`, `Gene Name`)
drug_links=read_csv("data/DRUGBANK_14_03_2024/drug links.csv")
approved=read_csv("data/DRUGBANK_14_03_2024/drug links_approved.csv")
drug_targets %>%
select("ID"=`DrugBank ID`, `UniProt ID`) %>%
inner_join(drug_target_ids, by = "UniProt ID") %>%
distinct() %>%
select(-`UniProt ID`) %>%
group_by(ID) %>%
summarize(Drug_Proteins=paste(`Gene Name`, collapse = ";")) %>%
ungroup() %>%
mutate(Number_of_Genes=str_count(Drug_Proteins, ";")+1) %>%
arrange(desc(Number_of_Genes)) %>%
select(ID, Number_of_Genes) %>%
count(Number_of_Genes) %>%
filter(Number_of_Genes >= 1 & Number_of_Genes <= 100) %>%
ggplot(aes(x=Number_of_Genes, y=n)) +
geom_bar(stat = "identity", width = 1) +
ylab("Count")
drug_targets %>%
select("ID"=`DrugBank ID`, `UniProt ID`) %>%
inner_join(drug_target_ids, by = "UniProt ID") %>%
distinct() %>%
select(-`UniProt ID`) %>%
na.omit(.) %>%
group_by(ID) %>%
summarize(Drug_Proteins=paste(`Gene Name`, collapse = ";")) %>%
ungroup() %>%
mutate(Number_of_Genes=str_count(Drug_Proteins, ";")+1) %>%
filter(Number_of_Genes<26) # %>% write_csv("out_data/network_data/drug_proteins.csv")
oncotargets_pre=readxl::read_xlsx("data/lists/oncotreat_list.xlsx", skip = 2)
d_count=max(str_count(oncotargets_pre$`Potential Drugs`, ";"), na.rm=T) +1
oncotargets_pre %>%
separate("Potential Drugs", into = paste0("d_", seq_len(d_count), sep=";")) %>%
pivot_longer(cols = starts_with("d_"), names_to = "Drug", values_to = "Molecule") %>%
select(-Drug) %>%
mutate(Molecule=trimws(Molecule)) %>%
filter(!is.na(Molecule)) -> oncotargetlist
prox_results=read_csv("out_data/network_data/consensus_insol/proximity_results_insol.csv")
prox_results %>%
separate(dc_pair, c("drug", "ecm_type"), sep = "_") %>%
select(-d, -mean, -sd) %>%
pivot_wider(names_from = ecm_type, values_from = z ) %>%
filter(drug%in%approved$`DrugBank ID`) %>%
inner_join(drug_links, by=c("drug"="DrugBank ID")) %>%
select(1:6) %>%
select(Name, poorest, poor, rich, richest, -drug) %>%
filter(Name%in%oncotargetlist$Molecule)  %>%
rowwise() %>%
mutate(variance = var(c_across(where(is.numeric)))) %>%
arrange(desc(variance)) %>%
filter(min(c_across(c(poorest, poor, rich, richest))) <= -1) %>%
ungroup()  -> oncotarget_drugs
oncotarget_drugs %>%
select(-variance) %>%
column_to_rownames("Name") %>%
filter(rowSums(.<=-2, na.rm=T)==2 | rowSums(.<=-2, na.rm=T)==1 ) %>%
rownames_to_column("name") -> int_filt
oncotarget_drugs %>%
filter(variance>0.4) %>%
select(-variance) %>%
column_to_rownames("Name") %>%
mutate(keep=ifelse((richest>=rich & poor>=poorest & richest>=poorest) | (richest<=rich & poor<=poorest & richest<=poorest),"yes","no")) %>%
filter(keep=="yes") %>%
select(-keep) %>%
rownames_to_column("name") -> soft_trend2
oncotarget_drugs %>%
filter(variance>0.4) %>%
select(-variance) %>%
column_to_rownames("Name") %>%
mutate(keep=ifelse((richest>=rich & rich>=poor & poor>=poorest) | (richest<=rich & rich<=poor & poor<=poorest),"yes","no")) %>%
filter(keep=="yes") %>%
select(-keep) %>%
rownames_to_column("name") -> harsh_trend2
df=data.frame(`ECM Grade` = c('ECM-G1', 'ECM-G2', 'ECM-G3', 'ECM-G4')) %>% rename("ECM Grade"="ECM.Grade")
row_anno_code = rowAnnotation(df = df,
col = list("ECM Grade" = c('ECM-G1' = '#B6CEC7','ECM-G2' = '#86A3C3', 'ECM-G3'='#7268A6', 'ECM-G4'='#6B3074')),
annotation_name_gp = gpar(fontsize=15,fontface = "bold"),
annotation_legend_param = list(`ECM Grade` = list(  title = "ECM Grade",
title_gp = gpar(fontface="bold", fontsize = 15),
labels_gp = gpar(fontsize = 15))))
int_filt %>%
full_join(soft_trend2) %>%
full_join(harsh_trend2) %>%
column_to_rownames("name") %>%
select("ECM-G1"=poorest, "ECM-G2"=poor,"ECM-G3"=rich,"ECM-G4"=richest) %>%
t() %>%
Heatmap(cluster_rows = F,
cluster_columns = T,
show_row_dend = F,
show_column_dend = F,
width = 1*unit(200,"mm"),
height = 1*unit(50,"mm"),
column_names_rot = 45,
row_names_gp = gpar(fontsize=20, fontface="bold"),
show_row_names = F,
column_names_gp = gpar(fontsize=15),
rect_gp = gpar("grey65"),
name = "proximity",
right_annotation = row_anno_code,
column_title = "",
column_title_gp = gpar(fontsize=20, fontface="bold"),
heatmap_legend_param = list(title = "Proximity", title_gp = gpar(fontface="bold", fontsize = 15), labels_gp = gpar(fontsize = 15)),
col = colorRamp2(c(-0.5,-4), c("white", "navy")))
dbs <- c("MSigDB_Hallmark_2020")
enriched <- enrichr(consensus_nodes_core$richest, dbs)
enriched[[1]] %>%
filter(Adjusted.P.value<=0.05) %>%
filter(!str_detect(Overlap, "2/")) %>%
mutate(adjp=-log10(Adjusted.P.value)) %>%
mutate(Term = str_replace(Term, " R-HSA-\\d+", "")) %>%
ggplot( aes(x = adjp, y = reorder(Term, adjp), fill = adjp)) +
geom_bar(stat = "identity", color="grey65")+
scale_fill_gradient(low = "white", high="#6B3074")+
xlab("-log10(Adjusted.P.value)")+
ylab("")+
labs(fill = "-log10(p-adj)")+
ggtitle("Hallmark Pathways")+
theme(panel.grid.major.y = element_blank(),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_line(color = "grey65"),
panel.grid.minor.x = element_blank(),
panel.background = element_blank(),
panel.border = element_rect(fill = NA, color = "grey65"),
axis.ticks.y = element_blank(),
axis.text.y.right = element_text(size=15, colour = "black"),
legend.position="none",
title = element_text(size=15, face="bold"),
axis.text.x = element_text(size=15, colour = "black"),
axis.title.y = element_text(size=15),
axis.title.x = element_text(size=15, face="bold"))+
scale_x_continuous(limits = c(0, 13), expand = c(0, 0))+
scale_y_discrete(position = "right")
